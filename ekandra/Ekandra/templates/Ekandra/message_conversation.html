{% extends 'Ekandra/base.html' %}
{% load bootstrap5 %} 
{% load static %} 


{% block title %}Conversation avec {{ destinataire.username }}{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'Ekandra/css/style.css' %}">
    {% bootstrap_css %}
   
{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-center mb-4 text-primary"><i class="bi bi-chat-dots me-2"></i> Conversation avec {{ destinataire.username }}</h1>  

    
    <div id="chat-log" class="border rounded p-3 mb-3 overflow-auto"> 
    
        {% for message in messages %}
            <div class="mb-2 {% if message.expediteur == request.user %}text-end{% else %}text-start{% endif %}"> 
            <p class="d-inline-block p-2 rounded-3 {% if message.expediteur == request.user %}bg-primary text-white{% else %}bg-light text-dark{% endif %}"> 
                 {{ message.contenu }}
                </p><br>
                <small class="text-muted">{{ message.expediteur.username }} - {{ message.date_envoi|date:"H:i" }}</small> 
            </div>
        {% endfor %}
    </div>

    
    <form id="chat-form" class="d-flex"> 
        <input type="text" id="chat-message-input" class="form-control flex-grow-1 rounded-start" placeholder="Ã‰crivez votre message..."> 
        <button type="submit" class="btn btn-primary flex-shrink-0"><i class="bi bi-send"></i></button>  
    </form>
</div>


{% bootstrap_javascript %}

<script>
    const recipientId = {{ destinataire.id }};
    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + recipientId + '/'
    );

    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data['message'];
        const senderUsername = data['sender_username'];
        const timestamp = data['timestamp']; 
        const chatLog = document.querySelector('#chat-log');
        const currentUser = "{{ request.user.username }}";

        const messageElement = document.createElement('div');
        messageElement.classList.add('mb-2');

        if (senderUsername === currentUser) {
            messageElement.classList.add('text-end');
        } else {
            messageElement.classList.add('text-start');
        }

        const metaSpan = document.createElement('small');
        metaSpan.classList.add('text-muted');
        metaSpan.textContent = `${senderUsername} - ${formatTimestamp(timestamp)}`;
        messageElement.appendChild(metaSpan);

        const contentPara = document.createElement('p');
        contentPara.classList.add('d-inline-block', 'p-2', 'rounded-3'); 
         if (senderUsername === currentUser) {
            contentPara.classList.add('bg-primary', 'text-white');
        } else {
            contentPara.classList.add('bg-light', 'text-dark');
        }
        contentPara.textContent = message;
        messageElement.appendChild(contentPara);

        chatLog.appendChild(messageElement);

        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  
            document.querySelector('#chat-form button[type="submit"]').click();
        }
    };

    document.querySelector('#chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInput = document.querySelector('#chat-message-input');
        const message = messageInput.value;
        if (message.trim() === '') {
             console.log("Cannot send empty message.");
             return;
        }
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInput.value = '';
    };

    window.onload = function() {
        const chatLog = document.querySelector('#chat-log');
        chatLog.scrollTop = chatLog.scrollHeight;
    };

</script>
{% endblock %}
{% block extra_css %}
     <link rel="stylesheet" href="{% static 'Ekandra/css/chat_style.css' %}"> 

{% endblock extra_css %}


