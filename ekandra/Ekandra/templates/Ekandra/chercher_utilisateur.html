{% extends 'Ekandra/base.html' %}
{% load static %}
{% load bootstrap5 %}
{% load i18n %}

{% block title %}{% trans "Trouver un interlocuteur" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'Ekandra/css/chercher.css' %}">
    <style>
        /* Ensure the base body styles apply from your global dark mode CSS */

/* --- Dark Mode Styles for "Trouver un interlocuteur" Specific Elements --- */

/* Header Section */
body.dark-mode .header-section {
    background: linear-gradient(135deg, #3a0ca3 0%, #4361ee 100%) !important; /* Darker, more vibrant gradient */
    box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important; /* Deeper shadow */
    color: #e2e8f0 !important; /* Ensure text is light */
}

body.dark-mode .header-icon-container .bi {
    color: #f8f9fa !important; /* Make icon pure white for contrast */
}

body.dark-mode .header-section h1 {
    color: #f8f9fa !important; /* Pure white for the main title */
}

body.dark-mode .header-section p {
    color: #e2e8f0 !important; /* Very light text for description */
}

/* Search Input Section */
body.dark-mode .search-input-group {
    background-color: #2d3748; /* Dark background for the input group */
    box-shadow: 0 5px 20px rgba(0,0,0,0.4) !important; /* Darker shadow */
}

body.dark-mode .form-control.border-0 {
    background-color: #4a5568 !important; /* Darker input field background */
    color: #e2e8f0 !important; /* Light text in input */
}

body.dark-mode .form-control.border-0::placeholder {
    color: #a0aec0 !important; /* Lighter placeholder text */
}

body.dark-mode .form-control.border-0:focus {
    box-shadow: 0 0 0 0.25rem rgba(76, 201, 240, 0.25) !important; /* Accent focus shadow */
    background-color: #4a5568 !important; /* Keep background consistent on focus */
}

body.dark-mode .btn-primary.btn-lg {
    background: linear-gradient(135deg, #3a0ca3, #4361ee) !important; /* Accent gradient for the button */
    border-color: #3a0ca3 !important;
    color: white !important;
}

body.dark-mode .btn-primary.btn-lg:hover {
    background: linear-gradient(135deg, #4361ee, #3a0ca3) !important;
    border-color: #4361ee !important;
}

/* Potential Contacts List Card */
body.dark-mode .contacts-list-card {
    background-color: #2d3748 !important; /* Dark background for the main card */
    box-shadow: 0 10px 30px rgba(0,0,0,0.6) !important; /* Deeper shadow */
}

body.dark-mode .contacts-list-card .card-title {
    background-color: #3a0ca3; /* Dark accent for card title bar */
    color: #e2e8f0 !important; /* Light text for the card title */
    border-bottom-color: #4361ee !important; /* Accent border */
}

/* List Group Items (Individual Contacts) */
body.dark-mode .list-group-item {
    background-color: #2d3748; /* Default background for list items */
    border-color: #4a5568 !important; /* Darker border between items */
    color: #e2e8f0; /* Default text color for items */
    transition: background-color 0.3s ease; /* Smooth transition for hover */
}

body.dark-mode .list-group-item.contact-item-hover:hover {
    background-color: #3a455a; /* Slightly lighter dark on hover */
}

/* Contact Avatar */
body.dark-mode .contact-avatar {
    background-color: #4a5568; /* Darker background for avatar placeholder */
    border-color: #4cc9f0 !important; /* Accent border if any */
}

body.dark-mode .contact-avatar .bi {
    color: #a0aec0 !important; /* Lighter icon color inside placeholder */
}

/* Contact Details Text */
body.dark-mode .contacts-list-card h5.text-dark {
    color: #e2e8f0 !important; /* Light text for username */
}

/* Badges (User Types) */
body.dark-mode .badge {
    opacity: 0.9; /* Slightly reduce opacity for badges in dark mode */
}

body.dark-mode .badge.bg-info-soft {
    background-color: rgba(76, 201, 240, 0.2) !important; /* Soft info dark mode background */
    color: #4cc9f0 !important; /* Accent info text */
}

body.dark-mode .badge.bg-success-soft {
    background-color: rgba(139, 219, 139, 0.2) !important; /* Soft success dark mode background */
    color: #8bdc8b !important; /* Accent success text */
}

body.dark-mode .badge.bg-secondary-soft {
    background-color: rgba(160, 174, 192, 0.2) !important; /* Soft secondary dark mode background */
    color: #a0aec0 !important; /* Accent secondary text */
}

/* Chat Icon */
body.dark-mode .chat-icon-container .bi {
    color: #4cc9f0 !important; /* Accent color for the chat icon */
}

/* Empty State Message */
body.dark-mode .empty-state {
    background-color: #2d3748 !important; /* Dark background for this section */
    color: #e2e8f0 !important; /* Light text */
}

body.dark-mode .empty-state .bi {
    color: #4cc9f0 !important; /* Accent color for the icon */
}

body.dark-mode .empty-state h3.text-dark {
    color: #e2e8f0 !important; /* Light text for heading */
}

body.dark-mode .empty-state p.text-secondary {
    color: #cbd5e0 !important; /* Lighter text for lead paragraph */
}

/* Back Button */
body.dark-mode .btn-outline-secondary.back-button-animated {
    border-color: #6b7280 !important; /* Darker border for outline button */
    color: #e2e8f0 !important; /* Light text for outline button */
}

body.dark-mode .btn-outline-secondary.back-button-animated:hover {
    background-color: #4a5568 !important; /* Darker background on hover */
    color: #f8f9fa !important; /* Pure white text on hover */
}
    </style>
{% endblock %}

{% block content %}
<div class="container my-5">
    {# Nouveau Header Section avec un dégradé plus dynamique et icône centrale #}
    <div class="header-section text-center mb-5 p-5">
        <div class="header-icon-container mb-4">
            <i class="bi bi-search-heart display-2 text-white animate__animated animate__bounceInDown"></i>
        </div>
        <h1 class="display-4 fw-bold text-white mb-3 animate__animated animate__fadeInUp">
            {% trans "Trouver un interlocuteur" %}
        </h1>
        <p class="lead text-white-75 mb-0 animate__animated animate__fadeInUp animate__delay-0-5s">
            {% trans "Connectez-vous avec d'autres utilisateurs pour démarrer de nouvelles conversations." %}
        </p>
    </div>

    {# Search Input Section avec un design plus intégré #}
    <div class="row justify-content-center mb-5">
        <div class="col-md-8 col-lg-6">
            <div class="input-group search-input-group shadow-lg rounded-pill overflow-hidden animate__animated animate__fadeIn animate__delay-1s">
                <input type="text" class="form-control form-control-lg border-0 ps-4 pe-2"
                       placeholder="{% trans 'Rechercher par nom d’utilisateur...' %}"
                       aria-label="Search by username" id="searchInput">
                <button class="btn btn-primary btn-lg px-4" type="button" id="searchButton">
                    <i class="bi bi-search me-2"></i> <span class="d-none d-md-inline-block">{% trans "Rechercher" %}</span>
                </button>
            </div>
        </div>
    </div>

    {# Potential Contacts List Card #}
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg rounded-4 contacts-list-card animate__animated animate__fadeInUp animate__delay-1-5s">
                <div class="card-body p-0">

                    <h2 class="card-title p-4 mb-0 text-primary fw-bold text-center border-bottom border-light">
                        {% trans "Utilisateurs disponibles" %}
                    </h2>

                    <div class="list-group list-group-flush" id="contactList">
                        {% for contact in potential_contacts %}
                            <a href="{% url 'message_conversation' contact.id %}"
                               class="list-group-item list-group-item-action d-flex align-items-center py-3 px-4 contact-item-hover"
                               data-username="{{ contact.username|lower }}">

                                <div class="contact-avatar me-3">
                                    {# Placeholder for user profile pictures #}
                                    <i class="bi bi-person-circle display-6 text-primary-light"></i>
                                </div>

                                <div class="flex-grow-1">
                                    <h5 class="mb-1 fw-bold text-dark">{{ contact.username }}</h5>
                                    {% if contact.profile.user_type == 'demandeur' %}
                                        <span class="badge bg-info-soft text-info fw-normal">{% trans "Demandeur d'emploi" %}</span>
                                    {% elif contact.profile.user_type == 'entreprise' %}
                                        <span class="badge bg-success-soft text-success fw-normal">{% trans "Entreprise" %}</span>
                                    {% else %}
                                         <span class="badge bg-secondary-soft text-secondary fw-normal">{% trans "Utilisateur" %}</span>
                                    {% endif %}
                                </div>

                                <div class="flex-shrink-0 chat-icon-container">
                                    <i class="bi bi-chat-dots-fill text-primary display-6"></i>
                                </div>
                            </a>
                        {% endfor %}
                    </div>
                    
                    {# Message "Aucun utilisateur trouvé" géré par JavaScript #}
                    <div class="p-5 text-center text-muted empty-state" style="display: none;">
                        <i class="bi bi-person-fill-slash display-1 text-primary-light mb-4"></i>
                        <h3 class="text-dark mb-3">{% trans "Aucun utilisateur trouvé." %}</h3>
                        <p class="lead text-secondary">{% trans "Veuillez essayer un autre nom ou ajuster votre recherche." %}</p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    {# Back Button #}
    <p class="mt-5 text-center animate__animated animate__fadeInUp animate__delay-2s">
        <a href="{% url 'messages' %}" class="btn btn-outline-secondary btn-lg rounded-pill back-button-animated">
            <i class="bi bi-arrow-left-circle me-2"></i> {% trans "Retour aux Messages" %}
        </a>
    </p>

</div>
{% endblock %}

{% block extra_js %}
    {% bootstrap_javascript %}
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const contactList = document.getElementById('contactList');
            const emptyStateDiv = document.querySelector('.contacts-list-card .empty-state');
            // Cache all contact items initially for efficient filtering
            const allContactItems = Array.from(contactList.querySelectorAll('.list-group-item'));
            
            // --- Accessibility (ARIA Live Region) ---
            // Create a live region for screen readers to announce search results
            const liveAnnouncementRegion = document.createElement('div');
            liveAnnouncementRegion.setAttribute('aria-live', 'polite'); // Announces changes but doesn't interrupt crucial updates
            liveAnnouncementRegion.setAttribute('aria-atomic', 'true'); // Ensures the whole region content is announced
            liveAnnouncementRegion.classList.add('sr-only'); // Visually hide but keep accessible
            document.body.appendChild(liveAnnouncementRegion);

            // Function to announce search results for screen readers
            const announceResults = (count, query) => {
                let message = '';
                if (query) {
                    message = `${count} utilisateur${count !== 1 ? 's' : ''} trouvé${count !== 1 ? 's' : ''} pour "${query}".`;
                } else {
                    // Announce total number of users when no search query is active
                    message = `Affichage de ${count} utilisateur${count !== 1 ? 's' : ''} disponibles.`;
                }
                liveAnnouncementRegion.textContent = message;
            };

            // --- Core Search Logic ---
            const performSearch = () => {
                const query = searchInput.value.toLowerCase().trim();
                let visibleCount = 0;

                allContactItems.forEach(item => {
                    const username = item.dataset.username; // Get username from data-username attribute
                    if (username && username.includes(query)) {
                        item.style.display = 'flex'; // Show the item
                        visibleCount++;
                    } else {
                        item.style.display = 'none'; // Hide the item
                    }
                });

                // Update visibility of "no users found" message and contact list
                if (visibleCount === 0) {
                    emptyStateDiv.style.display = 'block';
                    contactList.style.display = 'none'; // Hide the list container when empty
                } else {
                    emptyStateDiv.style.display = 'none';
                    contactList.style.display = 'block'; // Show the list container when items are visible
                }

                announceResults(visibleCount, query); // Announce results for accessibility
            };

            // --- Event Listeners ---
            searchInput.addEventListener('input', performSearch); // Real-time search on input

            const searchButton = document.getElementById('searchButton');
            if (searchButton) {
                searchButton.addEventListener('click', performSearch); // Search on button click
            }

            // --- Initial Load Logic ---
            // Perform an initial search if the input field already contains text
            // (e.g., if the user navigated back and the browser auto-filled the field)
            if (searchInput.value.length > 0) {
                performSearch();
            } else {
                // If the search input is empty on load, announce the total count
                announceResults(allContactItems.length, '');
            }
            
            // --- Initial visibility for the empty state ---
            // This is a more robust way to handle the initial visibility based on actual content
            if (allContactItems.length === 0) {
                emptyStateDiv.style.display = 'block';
                contactList.style.display = 'none';
            } else {
                emptyStateDiv.style.display = 'none';
                contactList.style.display = 'block';
            }

            // Optional: Auto-expand textarea for chat messages (if relevant on this page)
            // (This function seems to be from your message_detail page, ensuring it doesn't break here)
            window.autoExpandTextarea = function(textarea) {
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                }
            };
        });
    </script>

    {# Keep sombre.js here to ensure dark mode toggle functionality #}
    <script src="{% static 'Ekandra/js/sombre.js' %}"></script>
{% endblock %}